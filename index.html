<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Form handling
    const form = document.getElementById('analysisForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingState = document.getElementById('loadingState');
    const successMessage = document.getElementById('successMessage');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('border-red-500');
                field.focus();
            } else {
                field.classList.remove('border-red-500');
            }
        });

        // Additional email validation
        const emailField = form.querySelector('[type="email"]');
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailField && !emailPattern.test(emailField.value)) {
            isValid = false;
            emailField.classList.add('border-red-500');
            alert('Please enter a valid email address');
            emailField.focus();
            return;
        }

        if (!isValid) {
            alert('Please fill in all required fields (marked with *)');
            return;
        }

        // Show loading state
        form.classList.add('hidden');
        loadingState.classList.remove('hidden');

        // Build URL with parameters
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                params.append(key, value.trim());
            }
        }

        const webhookUrl = 'https://contentlabs.app.n8n.cloud/webhook/competitor-products-brief';
        const fullUrl = webhookUrl + '?' + params.toString();

        try {
            console.log('🚀 Sending request to:', fullUrl);
            
            // Отправляем запрос
            const response = await fetch(fullUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html,application/json'
                }
            });

            console.log('📥 Response status:', response.status);
            console.log('📄 Content-Type:', response.headers.get('content-type'));

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Error response:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
            }

            // Проверяем тип контента
            const contentType = response.headers.get('content-type') || '';
            
            if (contentType.includes('text/html')) {
                // Получаем HTML
                const htmlContent = await response.text();
                console.log('✅ Received HTML, length:', htmlContent.length);

                // Открываем в новой вкладке
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const newWindow = window.open(url, '_blank');

                if (!newWindow) {
                    alert('⚠️ Popup blocked! Please allow popups for this site and try again.');
                    throw new Error('Popup blocked');
                }

                // Показываем success message
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    lucide.createIcons();

                    // Сброс формы через 3 секунды
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                        form.classList.remove('hidden');
                        form.reset();
                        lucide.createIcons();
                        URL.revokeObjectURL(url); // Очистка
                    }, 3000);
                }, 500);

            } else if (contentType.includes('application/json')) {
                // Если вернули JSON (на случай ошибки)
                const result = await response.json();
                console.log('📊 JSON response:', result);

                if (result.success && result.view_url) {
                    // Открыть URL из JSON
                    window.open(result.view_url, '_blank');
                    
                    loadingState.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                        form.classList.remove('hidden');
                        form.reset();
                    }, 3000);
                } else {
                    throw new Error(result.error || result.message || 'Unknown error');
                }
            } else {
                throw new Error(`Unexpected content type: ${contentType}`);
            }

        } catch (error) {
            console.error('❌ Error:', error);
            
            // Показываем более детальную ошибку
            let errorMessage = 'Failed to generate analysis. Please try again.';
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Network error. Please check your internet connection.';
            } else if (error.message.includes('Popup blocked')) {
                errorMessage = 'Please allow popups for this site and try again.';
            } else {
                errorMessage = error.message;
            }
            
            alert('⚠️ Error\n\n' + errorMessage);
            
            // Вернуться к форме
            loadingState.classList.add('hidden');
            form.classList.remove('hidden');
        }
    });

    // Add smooth scroll effect
    document.querySelectorAll('input, textarea').forEach(field => {
        field.addEventListener('focus', function() {
            this.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    });

    // Auto-save form data to localStorage (optional)
    const saveFormData = () => {
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (value.trim()) data[key] = value.trim();
        }
        localStorage.setItem('competitorAnalysisForm', JSON.stringify(data));
    };

    const loadFormData = () => {
        const saved = localStorage.getItem('competitorAnalysisForm');
        if (saved) {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(key => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = data[key];
                    if (field.type === 'radio' && field.value === data[key]) {
                        field.checked = true;
                    }
                }
            });
        }
    };

    // Load saved data on page load
    loadFormData();

    // Save on input
    form.addEventListener('input', saveFormData);

    // Clear saved data on successful submit
    form.addEventListener('submit', () => {
        setTimeout(() => {
            localStorage.removeItem('competitorAnalysisForm');
        }, 4000);
    });
</script>
